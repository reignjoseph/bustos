{% extends "menu/menu_navigation.html" %}
{% block content %}
    <main class="base_signup">
        <form id="signupForm" class="signup-form" method="POST">
        <div class="signup-container">
            <h2>Sign Up As</h2>
            <div id="js-error-message" class="alert alert-danger alert-dismissible fade show" role="alert" style="text-align: center; display: none; padding-left: 2rem; padding-right: 2rem;">
                <span id="js-error-text"></span>
                <!-- <button type="button" class="close" data-dismiss="alert" aria-label="Close" style="right: 0px; top: -15px; width: 0; height: 0; outline:none;"> -->
                    <!-- <span aria-hidden="true">&times;</span> -->
                </button>
            </div>

            
                <div class="form-group-1 form-group-radio"> <label> <input type="radio" name="role" value="Jobseeker" required> Jobseeker </label> <label> <input type="radio" name="role" value="Employer" required> Employer </label> </div> <div class="form-group-2 abc"> <label for="name">Name:</label> <input type="text" id="name" name="name" required> </div> <div class="form-group-3 abc"> <label for="email">Email:</label> <input type="email" id="email" name="email" required> </div> <div class="form-group-4 abc password-group"> <label for="password">Password:</label> <input type="password" id="password" name="password" required> <span class="toggle-password" onclick="togglePasswordVisibility()"> <img class="eye" src="/static/images/eye-open.png" alt="Toggle Password"> </span> </div> <div class="form-group-5"> <label> <input type="checkbox" name="terms" required> I agree to the <a href="#">Terms of Service</a> </label> </div>
                <div class="form-group-6">
                    <button type="button" onclick="displayDetails()" class="btn-signup">Additional Details</button>
                </div> 
                <div class="modal fade" id="registrationModal" tabindex="-1" role="dialog" aria-labelledby="registrationModalLabel" aria-hidden="true">
                    <div class="modal-dialog" role="document">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="registrationModalLabel">Additional Registration Details <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                    <span aria-hidden="true">&times;</span>
                                </button></h5>
                                
                            </div>
                            <div class="modal-body" style="padding: 10px;">
                                {% include 'menu/registration_form_jobseeker.html' %}
                                {% include 'menu/registration_form_employer.html' %}
                            </div>
                            <div class="modal-footer" style="justify-content: space-between;">
                                <div class="exclusiveforemployeronly" style="display:none;flex-direction: column; align-content: center; justify-content: center; align-items: baseline; ">
                                    <p style="margin-top:30px;">Upload valid file of Barangay Clearance, Business Permit, and BIR.</p>
                                    <!-- <button type="button" onclick="uploadBIR_BP_BC()">Upload Files</button> -->
                                    <input type="file" id="attach_file" accept=".png, .jpg, .jpeg, .pdf" onchange="validateBIR_BP_BC(this)" multiple>
                                    <p id="fileHint" style="display:none; color: red;">Please upload a valid file: PNG, JPG, or PDF.</p>
                                    </div>
                                <button style="width: 20%;" type="button" onclick="validateAndSubmit()" id="generate-pdf" class="btn-signup">Submit</button>
                            </div>
                        </div>
                    </div>
                </div>

            <div class="signin-link">
                Have an already Account? <a href="/signin">Click Sign In</a>
            </div>
        </div>
    </form>
</main>



<!-- <script>
    document.getElementById('generate-pdf').addEventListener('click', () => {
        const element = document.querySelector('.form-container_registration'); // Adjust the selector to your form container class or ID
        html2pdf().from(element).save('form-content.pdf');
    });
    </script> -->








<script>
document.addEventListener("DOMContentLoaded", function() {
    // Select both radio buttons
    var roleRadios = document.querySelectorAll('input[name="role"]');

    // Function to toggle the display of jobseeker and employer forms

    // Add event listener to each radio button
    roleRadios.forEach(function(radio) {
        radio.addEventListener('change', toggleFormsDisplay);
    });

});



function toggleFormsDisplay() {
    var selectedRole = document.querySelector('input[name="role"]:checked').value;
    var jobseekerForm = document.querySelector(".form-container_registration_jobseeker");
    var employerForm = document.querySelector(".form-container_registration_employer");
    var exclusiveSection = document.querySelector('.exclusiveforemployeronly');

    // Show the jobseeker form if "Jobseeker" is selected, hide the employer form
    if (selectedRole === "Jobseeker") {
        jobseekerForm.style.display = "block"; // Show Jobseeker form
        employerForm.style.display = "none";   // Hide Employer form
        exclusiveSection.style.display = 'none'; 

        // Add required attribute back to specific fields in Jobseeker form
        document.querySelectorAll('input[name="surname"], input[name="firstname"], input[name="middlename"], input[name="birthdate"], input[name="sex"], input[name="address"], input[name="barangay"], input[name="municipality"], input[name="province"], input[name="religion"], input[name="civilstatus"], input[name="contact_no"], input[name="emailaddress"]').forEach(function(field) {
            field.setAttribute('required', 'required');
        });

        // Remove required attribute from specific fields in Employer form
        document.querySelectorAll('input[name="employer_business"], input[name="employer_trade"], input[name="employer_acronym"]').forEach(function(field) {
            field.removeAttribute('required');
        });
    } 
    // Show the employer form if "Employer" is selected, hide the jobseeker form
    else if (selectedRole === "Employer") {
        jobseekerForm.style.display = "none";  // Hide Jobseeker form
        employerForm.style.display = "block";  // Show Employer form
        exclusiveSection.style.display = 'flex';

        // Add required attribute back to specific fields in Employer form
        document.querySelectorAll('input[name="employer_business"], input[name="employer_trade"], input[name="employer_acronym"]').forEach(function(field) {
            field.setAttribute('required', 'required');
        });

        // Remove required attribute from specific fields in Jobseeker form
        document.querySelectorAll('input[name="surname"], input[name="firstname"], input[name="middlename"], input[name="birthdate"], input[name="sex"], input[name="address"], input[name="barangay"], input[name="municipality"], input[name="province"], input[name="religion"], input[name="civilstatus"], input[name="contact_no"], input[name="emailaddress"]').forEach(function(field) {
            field.removeAttribute('required');
        });
    }
}










function displayDetails() {
    var selectedRole = document.querySelector('input[name="role"]:checked'); // Get the selected radio button
    var errorMessageDiv = document.getElementById("js-error-message");
    var errorMessageText = document.getElementById("js-error-text");

    // Check if a role is selected
    if (!selectedRole) {
        errorMessageDiv.style.display = "block";
        errorMessageText.innerHTML = "Please select a role.";
        return; // Exit if no role is selected
    }

    selectedRole = selectedRole.value; // Get the value of the selected role

    var name = document.getElementById("name");
    var email = document.getElementById("email");
    var password = document.getElementById("password");
    var terms = document.querySelector('input[name="terms"]');

    let errorMessages = [];

    // Validate name and trigger default validation message
    if (!name.checkValidity()) {
        name.focus(); // Set focus on the name input
        name.reportValidity(); // Trigger the default validation message
        return; // Exit if name is invalid
    }

    // Validate email and trigger the default validation message
    if (!email.checkValidity()) {
        email.focus(); // Set focus on the email input
        email.reportValidity(); // Trigger the default validation message
        return; // Exit if email is invalid
    }

    // Validate password and trigger default validation message
    if (!password.checkValidity()) {
        password.focus(); // Set focus on the password input
        password.reportValidity(); // Trigger the default validation message
        return; // Exit if password is invalid
    } else {
        const minLength = 8;
        const maxLength = 30;
        const upperCasePattern = /[A-Z]/; // At least one uppercase letter
        const lowerCasePattern = /[a-z]/; // At least one lowercase letter
        const numberPattern = /[0-9]/; // At least one number
        const specialCharPattern = /[!@#$%^&*(),.?":{}|<>]/; // At least one special character

        // Check for password length
        if (password.value.length < minLength || password.value.length > maxLength) {
            errorMessages.push(`Password must be between ${minLength} and ${maxLength} characters.`);
        }

        // Check for uppercase letter
        if (!upperCasePattern.test(password.value)) {
            errorMessages.push("Password must include at least one uppercase letter.");
        }

        // Check for lowercase letter
        if (!lowerCasePattern.test(password.value)) {
            errorMessages.push("Password must include at least one lowercase letter.");
        }

        // Check for number
        if (!numberPattern.test(password.value)) {
            errorMessages.push("Password must include at least one number.");
        }

        // Check for special character
        if (!specialCharPattern.test(password.value)) {
            errorMessages.push("Password must include at least one special character.");
        }
    }

    // Validate terms and trigger default validation message
    if (!terms.checked) {
        terms.focus(); // Set focus on the terms checkbox
        alert("You must agree to the Terms of Service."); // Custom alert for the terms
        return; // Exit if terms are not agreed upon
    }

    // If there are error messages, display them
    if (errorMessages.length > 0) {
        errorMessageDiv.style.display = "block";
        errorMessageText.innerHTML = errorMessages.join('<br>'); // Display the combined error messages with line breaks
        return; // Exit if validation fails
    }

    // Hide the error message div if validation passes
    errorMessageDiv.style.display = "none";
    toggleFormsDisplay();

    // Perform the AJAX call to check email
    $.ajax({
        url: "/check_email",
        method: "POST",
        data: { email: email.value.trim(), role: selectedRole }, // Include selectedRole in the data
        success: function(response) {
            if (response.email_exists) {
                errorMessageDiv.style.display = "block";
                errorMessageText.innerHTML = "Email is already registered.";
            } else {
                // Email is not registered, show additional details section
                $('#registrationModal').modal('show');
            }
        },
        error: function() {
            errorMessageDiv.style.display = "block";
            errorMessageText.innerHTML = "An error occurred. Please try again.";
        }
    });
}






</script>

<script>
    function togglePasswordVisibility() {
        var passwordField = document.getElementById("password");
        var eyeIcon = document.querySelector(".eye");

        if (passwordField.type === "password") {
            passwordField.type = "text";
            eyeIcon.src = "/static/images/eye-close.png";
        } else {
            passwordField.type = "password";
            eyeIcon.src = "/static/images/eye-open.png";
        }
    }

function validateAndSubmit() {
    var form = document.getElementById("signupForm");
    var email = form.querySelector("input[name='email']").value;
    var selectedRole = document.querySelector('input[name="role"]:checked').value;

    // Validate the business name input first
    // Continue with the rest of the form submission process...
    $.ajax({
        url: "/check_email",
        method: "POST",
        data: { email: email },
        success: function(response) {
            if (response.email_exists) {
                alert("Email is already registered. Please use a different email.");
                return;
            } else {
                if (form.checkValidity()) {
                    $.ajax({
                        url: "/create_account",
                        method: "POST",
                        data: new FormData(form),
                        contentType: false,
                        processData: false,
                        success: function(createAccountResponse) {
                            var pdfFilename = selectedRole === "Jobseeker" ? 'form-content-jobseeker.pdf' : 'form-content-employer.pdf';
                            var uploadUrl = selectedRole === "Jobseeker" ? '/insert_html2pdf_jobseeker' : '/insert_html2pdf_employer';
                            var formClass = selectedRole === "Jobseeker" ? '.form-container_registration_jobseeker' : '.form-container_registration_employer';

                            generateAndUploadPDF(formClass, pdfFilename, uploadUrl, email).then(() => {
                                window.location.href = "/signin"; // Redirect to signin
                            }).catch((error) => {
                                alert("Error generating or uploading the PDF. Please try again.");
                            });
                        },
                        error: function() {
                            alert("Error creating account.");
                        }
                    });
                } else {
                    form.reportValidity(); // This will trigger any built-in HTML5 validation
                    validateBusinessName();
                    validateTradeName();
                    validateAcronym();
                    validateTaxIdentifier();
                    validateLineOfBusinessIndustry();
                    validateMobileNumber();
                    validateOwnerName();
                    validateContactName();
                    validatePosition();
                    validateFaxNumber();
                    validateEmailAddress();
                }
            }
        },
        error: function() {
            alert("Error checking email.");
        }
    });
}


function validateBusinessName() {
    const businessNameGroup = document.getElementById('business_name_group');
    const businessNameInput = businessNameGroup.querySelector('input[name="employer_business"]');
                            
    // Check if the input field is empty or invalid
    if (!businessNameInput.checkValidity()) {
        businessNameGroup.classList.add('error_background_color'); // Add error background if invalid
    } else {
        businessNameGroup.classList.remove('error_background_color'); // Remove error background if valid
                            }
}
function validateTradeName() {
        const tradeNameGroup = document.getElementById('trade_name_group');
        const tradeNameInput = tradeNameGroup.querySelector('input[name="employer_trade"]');

        if (!tradeNameInput.checkValidity()) {
            tradeNameGroup.classList.add('error_background_color'); // Add red background if invalid
            return false;
        } else {
            tradeNameGroup.classList.remove('error_background_color'); // Remove red background if valid
            return true;
        }
    }
function validateAcronym() {
        const acronymGroup = document.getElementById('acronym_group');
        const acronymInput = acronymGroup.querySelector('input[name="employer_acronym"]');

        if (!acronymInput.checkValidity()) {
            acronymGroup.classList.add('error_background_color'); // Add red background if invalid
            return false;
        } else {
            acronymGroup.classList.remove('error_background_color'); // Remove red background if valid
            return true;
        }
    }
function validateTaxIdentifier() {
    const taxIdentifierInput = document.querySelector('input[name="employer_tax_identifier_number"]'); // Get the input element
    let taxIdentifierValue = taxIdentifierInput.value; // Get the input value

    // Remove non-digit characters
    const digitsOnly = taxIdentifierValue.replace(/\D/g, ''); // Keep only numbers

    // Limit to 9 digits (for 11 characters including hyphens)
    if (digitsOnly.length > 9) {
        taxIdentifierValue = digitsOnly.slice(0, 9); // Keep only the first 9 digits
    } else {
        taxIdentifierValue = digitsOnly; // Use the current valid digits
    }

    // Format as nnn-nnn-nnn
    if (taxIdentifierValue.length > 0) {
        const formattedValue = taxIdentifierValue.replace(/(\d{3})(?=\d)/g, '$1-'); // Add hyphens
        taxIdentifierInput.value = formattedValue.substring(0, 11); // Limit the input to 11 characters
    } else {
        taxIdentifierInput.value = ''; // Reset the input if no digits are present
    }

    // Check if the input is valid
    if (taxIdentifierInput.value.length !== 11) {
        document.getElementById('taxIdentifierver1').style.backgroundColor = 'lightcoral'; // Set error background color
        return false;
    }

    // Reset background color of the parent label if valid
    document.getElementById('taxIdentifierver1').style.backgroundColor = ''; 
    return true;
}
function validateLineOfBusinessIndustry() {
    const lineOfBusinessInput = document.querySelector('input[name="employer_line_of_business_industry"]'); // Get the input element
    const lineOfBusinessContainer = document.getElementById('lineOfBusinessContainer'); // Get the div element
    const lineOfBusinessValue = lineOfBusinessInput.value.trim(); // Get the trimmed input value

    // Check if the input is empty
    if (lineOfBusinessValue === "") {
        lineOfBusinessInput.classList.add('error_background_color'); // Add error class to input
        lineOfBusinessContainer.classList.add('error_background_color'); // Add error class to container
        return false;
    }

    // Reset background color of the input and container if valid
    lineOfBusinessInput.classList.remove('error_background_color'); 
    lineOfBusinessContainer.classList.remove('error_background_color'); 
    return true;
}
function validateMobileNumber() {
    const input = document.getElementById('employer_mobile_number'); // Get the input element
    let digits = input.value.replace(/\D/g, ''); // Keep only digits, excluding '+'

    // Ensure the input always starts with +63
    if (!input.value.startsWith('+63')) {
        digits = '63' + digits; // Add '63' to the digits if it is not there
    }

    // Limit to exactly 10 digits after the +63 (12 digits total)
    if (digits.length > 12) {
        digits = digits.slice(0, 12); // Trim to 12 digits (including the '63')
    }

    // Update the input field with the +63 prefix and only digits
    input.value = '+63' + digits.slice(2); // Ensure the input starts with +63

    // Check for validity (exactly 12 digits, including the +63)
    const label = document.getElementById('employer_mobile_number_container'); // Get the label element
    const isValid = digits.length === 12; // Check if it has exactly 12 digits (including '63')

    if (!isValid) { // If less than 12 digits, it's invalid
        input.classList.add('error_background_color'); // Add error background to input
        label.classList.add('error_background_color'); // Add error background to label
    } else {
        input.classList.remove('error_background_color'); // Remove error background from input if valid
        label.classList.remove('error_background_color'); // Remove error background from label if valid
    }

    return isValid; // Return true if valid, false otherwise
}
function validateOwnerName() {
        const input = document.getElementById('employer_president'); // Get the input element
        const namePattern = /^[A-Za-z\s]+$/; 
        const parentDiv = document.getElementById('nameofownercontainer'); // Get the parent div

        if (!namePattern.test(input.value)) { // If the input doesn't match the pattern
            input.classList.add('error_background_color'); // Add error background to input
            parentDiv.classList.add('error_background_color'); // Add error background to the parent div
        } else {
            input.classList.remove('error_background_color'); // Remove error background if valid
            parentDiv.classList.remove('error_background_color'); // Remove error background from parent div if valid
        }
    }
function validateContactName() {
        const input = document.getElementById('employer_contact'); // Get the input element
        const namePattern = /^[A-Za-z\s]+$/; 
        const parentDiv = document.getElementById('contactpersoncontainer'); // Get the parent div

        if (!namePattern.test(input.value)) { // If the input doesn't match the pattern
            input.classList.add('error_background_color'); // Add error background to input
            parentDiv.classList.add('error_background_color'); // Add error background to the parent div
        } else {
            input.classList.remove('error_background_color'); // Remove error background if valid
            parentDiv.classList.remove('error_background_color'); // Remove error background from parent div if valid
        }
    }
function validatePosition() {
        const input = document.getElementById('employer_position'); // Get the input element
        const namePattern = /^[A-Za-z\s]+$/; 
        const parentDiv = document.getElementById('positioncontainer'); // Get the parent div

        if (!namePattern.test(input.value)) { // If the input doesn't match the pattern
            input.classList.add('error_background_color'); // Add error background to input
            parentDiv.classList.add('error_background_color'); // Add error background to the parent div
        } else {
            input.classList.remove('error_background_color'); // Remove error background if valid
            parentDiv.classList.remove('error_background_color'); // Remove error background from parent div if valid
        }
    }
function validateFaxNumber() {
        const input = document.getElementById('employer_fax_number'); // Get the input element
        let digits = input.value.replace(/\D/g, ''); // Keep only digits

        // Limit to exactly 10 digits for validation
        if (digits.length > 10) {
            digits = digits.slice(0, 10); // Trim to 10 digits
        }

        // Update the input field with the cleaned digits
        input.value = digits;

        // Check for validity (exactly 10 digits)
        const label = document.getElementById('fax_number_container'); // Get the label element
        const isValid = digits.length === 10; // Check if it has exactly 10 digits

        if (!isValid) { // If less than 10 digits, it's invalid
            input.classList.add('error_background_color'); // Add error background to input
            label.classList.add('error_background_color'); // Add error background to container
        } else {
            input.classList.remove('error_background_color'); // Remove error background from input if valid
            label.classList.remove('error_background_color'); // Remove error background from container if valid
        }

        return isValid; // Return true if valid, false otherwise
    }
function validateEmailAddress() {
        const input = document.getElementById('employer_email_address'); // Get the input element
        const label = document.getElementById('employer_email_address_container'); // Get the label element

        const isValid = input.checkValidity(); // Use the built-in email validation

        if (!isValid) { // If the email format is invalid
            input.classList.add('error_background_color'); // Add error background to input
            label.classList.add('error_background_color'); // Add error background to container
        } else {
            input.classList.remove('error_background_color'); // Remove error background from input if valid
            label.classList.remove('error_background_color'); // Remove error background from container if valid
        }

        return isValid; // Return true if valid, false otherwise
    }


















function generateAndUploadPDF(elementSelector, filename, uploadUrl, email) {
    return new Promise((resolve, reject) => {
        const element = document.querySelector(elementSelector);

        const options = {
            margin: [0.25, 0.25, 0.25, 0.25],
            filename: filename,
            image: { type: 'jpeg', quality: 1 },
            html2canvas: { scale: 4 },
            jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
        };

        // Generate PDF
        html2pdf().from(element).set(options).output('datauristring').then(dataUri => {
            if (!dataUri) {
                alert('No content to generate PDF.');
                return reject();
            }

            const byteString = atob(dataUri.split(',')[1]);
            const mimeString = dataUri.split(',')[0].split(':')[1].split(';')[0];
            const ab = new ArrayBuffer(byteString.length);
            const ia = new Uint8Array(ab);

            for (let i = 0; i < byteString.length; i++) {
                ia[i] = byteString.charCodeAt(i);
            }

            const blob = new Blob([ab], { type: mimeString });

            // Upload PDF to server
            const formData = new FormData();
            formData.append('pdf', blob, filename); // Use the generated filename
            formData.append('email', email);

            fetch(uploadUrl, {
                method: 'POST',
                body: formData
            }).then(response => {
                if (response.ok) {
                    resolve();
                } else {
                    alert('Failed to upload PDF.');
                    reject();
                }
            }).catch(() => {
                alert('An error occurred while uploading the PDF.');
                reject();
            });
        }).catch(() => {
            alert('An error occurred while generating the PDF.');
            reject();
        });
    });
}



</script>

{% endblock %}