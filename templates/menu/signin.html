{% extends "menu/menu_navigation.html" %}
{% block content %}
<main class="base_signin">

    
    <div class="forgot_password-form" id="forgot_password_form_div" style="display: none;">
        <img id="close_forgot_password" src="static/images/close.png" alt="Close" style="cursor: pointer; width: 30px;" onclick="closeForgotPassword()">
        <div style="padding: 0px 20px 20px 20px; display: flex; flex-direction: column; gap: 10px;">
            <h2>Forgot Password</h2>
            <form id="forgot_password_form" action="/forgot_password_update" method="post">
                <div id="requesterrormessage" style="color: red;"></div>

                <label for="otp">OTP:</label>
                <input type="text" id="otp" name="otp" placeholder="Enter OTP" required=""><br>
    
                <button type="button" id="send_otp" onclick="requestOtp()">Send OTP</button>
    
                <label for="forgot_password_new">New Password:</label>
                <input type="password" id="forgot_password_new" name="forgot_password_new" required=""><br>
    
                <label for="forgot_password_confirm">Confirm New Password:</label>
                <input type="password" id="forgot_password_confirm" name="forgot_password_confirm" required=""><br>
    
                <button id="forgot_password_submit" type="submit" onclick="validateForgotPassword()">Update Password</button>
            </form>
        </div>
    </div>

    
















    <script>
        // Function to handle sending OTP
        function requestOtp() {
            const email = document.getElementById('forgot_password_email').value;
            clearErrorMessage(); // Clear previous error messages
        
            if (!email) {
                displayErrorMessage('Please enter your email.');
                return;
            }
        
            fetch('/send_otp', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ forgot_password_email: email }),
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(errorData => {
                        displayErrorMessage(errorData.error || "No email was found on the table, no OTP was sent.");
                    });
                }
                alert("OTP has been sent to your email!"); // Show success message
                localStorage.setItem('forgot_password_email', email); // Save email in localStorage
            })
            .catch(error => {
                console.log('Caught error:', error.message); // Log it as a normal message
            });
        }
        </script>
        














    <script>

function forgotPasswordBtn() {
    const emailInput = document.querySelector('input[name="email"]');  // Find the email input field
    const errorMessageDiv = document.getElementById('error_forgot_password_message');  // Error message div
    const cooldownErrorMessageDiv = document.getElementById('cooldown_error_message');  // New cooldown error message div
    const forgotPasswordFormDiv = document.getElementById('forgot_password_form_div');  // Forgot password form div
    const forgotPasswordEmailInput = document.createElement('input'); // Dynamically create email input
    
    forgotPasswordEmailInput.type = 'email';
    forgotPasswordEmailInput.id = 'forgot_password_email';
    forgotPasswordEmailInput.name = 'forgot_password_email';
    forgotPasswordEmailInput.style.display = 'none';  // Hide the input
    forgotPasswordFormDiv.appendChild(forgotPasswordEmailInput); // Append the input to the form

    const email = emailInput.value.trim();  // Get the email value

    // Clear any previous error messages and hide the forgot password form
    errorMessageDiv.textContent = '';
    cooldownErrorMessageDiv.textContent = '';  // Clear cooldown error message
    forgotPasswordFormDiv.style.display = 'none';  // Initially hide the forgot password form

    // Check if email is empty
    if (!email) {
        errorMessageDiv.textContent = 'Please enter your email first';  // Display error for empty email
        return;
    }

    // Send POST request to check the email
    fetch('/forgot_password_check_email', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ email: email }),
    })
    .then(response => response.json())
    .then(data => {
        console.log(data.message);  // Log the message from the server

        // Check if the email is approved
        if (data.message === 'Approved') {
            // If email is approved, display the forgot password form
            forgotPasswordFormDiv.style.display = 'block';  // Show forgot password form
            forgotPasswordFormDiv.style.position = "absolute";
            forgotPasswordEmailInput.value = email;  // Set the email in the hidden field
            forgotPasswordEmailInput.readOnly = true;  // Make the email field readonly
        } else if (data.cooldown) {
            // If the cooldown message is returned, display it
            cooldownErrorMessageDiv.textContent = data.cooldown;  // Show cooldown error message
        } else {
            // Display the message from the backend in the error div
            errorMessageDiv.textContent = data.message;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        errorMessageDiv.textContent = 'An error occurred. Please try again later.';  // Display general error message
    });
}




function closeForgotPassword() {
    document.getElementById('forgot_password_form_div').style.display = 'none';  // Hide the forgot password form
}
// Function to validate the OTP
function validateOtp(email, enteredOtp) {
    const errorMessageDiv = document.getElementById('requesterrormessage'); // Get the error message div
    errorMessageDiv.innerText = ''; // Clear previous messages

    // Check if the email exists in otp_storage
    if (email in otp_storage) {
        const storedData = otp_storage[email];
        const currentTime = Date.now() / 1000; // Get current time in seconds

        // Validate the entered OTP against the stored OTP
        if (storedData['otp'] === enteredOtp) {
            // Check if the OTP is still valid (not expired)
            if (currentTime - storedData['timestamp'] < 180) {  // Check for expiration
                delete otp_storage[email]; // Invalidate the OTP
                console.log(`OTP validation successful for ${email}. OTP is valid.`);
                return true; // OTP is valid
            } else {
                // OTP expired
                console.log(`OTP for ${email} has expired.`);
                errorMessageDiv.innerText = "OTP expired."; // Display error message
                return false; // OTP expired
            }
        } else {
            // OTP does not match
            console.log(`Entered OTP for ${email} does not match the stored OTP.`);
            errorMessageDiv.innerText = "Wrong OTP."; // Display error message
            return false; // OTP invalid
        }
    } else {
        // No OTP found for the given email
        console.log(`No OTP found for ${email}.`);
        errorMessageDiv.innerText = "No OTP found for this email."; // Display error message
        return false; // No OTP found
    }
}

// Validate password entries function
function validateForgotPassword() {
    const newPassword = document.getElementById('forgot_password_new').value;
    const confirmPassword = document.getElementById('forgot_password_confirm').value;
    const errorMessageDiv = document.getElementById('requesterrormessage'); // Get the error message div
    errorMessageDiv.innerText = ''; // Clear previous messages

    if (newPassword !== confirmPassword) {
        errorMessageDiv.innerText = 'New password does not match.'; // Display error message
        return false; // Prevent form submission
    }
    return true; // Allow form submission
}



// Event listener for form submission
document.getElementById('forgot_password_form').onsubmit = function(event) {
    event.preventDefault(); // Prevent the default form submission

    const email = document.getElementById('forgot_password_email').value;
    const otpEntered = document.getElementById('otp').value;
    const newPassword = document.getElementById('forgot_password_new').value;

    // Validate the new password and confirmation before proceeding
    if (!validateForgotPassword()) {
        return; // Stop execution if validation fails
    }

    clearErrorMessage(); // Clear previous error messages

    fetch('/forgot_password_update', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            forgot_password_email: email,
            otp: otpEntered,
            forgot_password_new: newPassword
        })
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(errorData => {
                throw new Error(errorData.error || 'Unknown error occurred');
            });
        }
        return response.json(); // Expect a JSON response for success
    })
    .then(data => {
        // Handle success
        alert(data.message); // Show success message
        closeForgotPassword(); // Close the form after success
        resetForm(); // Reset input fields
    })
    .catch(error => {
        // Display error message
        const errorMessageDiv = document.getElementById('requesterrormessage');
        errorMessageDiv.innerText = error.message; // Display the error message
        console.error('Error:', error);
    });
};

// Clear previous error messages
function clearErrorMessage() {
    const errorMessageDiv = document.getElementById('requesterrormessage');
    errorMessageDiv.innerText = ''; // Clear previous messages
}

// Function to close the forgot password form
function closeForgotPassword() {
    document.getElementById('forgot_password_form_div').style.display = 'none'; // Hide the form
    resetForm();
}

// Utility functions for error message handling
function displayErrorMessage(message) {
    const errorMessageDiv = document.getElementById('error_forgot_password_message');
    errorMessageDiv.innerText = message; // Display the error message
}

function clearErrorMessage() {
    const errorMessageDiv = document.getElementById('error_forgot_password_message');
    errorMessageDiv.innerText = ''; // Clear the error message
}

// Function to reset the form fields
function resetForm() {
    document.getElementById('forgot_password_email').value = '';
    document.getElementById('otp').value = '';
    document.getElementById('forgot_password_new').value = '';
    document.getElementById('forgot_password_confirm').value = '';
    document.getElementById('login_email').value = ''; // Clear the login_email field
    localStorage.removeItem('forgot_password_email'); // Remove from local storage
}

    </script>














  <div class="container-login">
<!-- Forgot Password Form -->
    <div class="form-box-login">
        <h2>Sign in to your account</h2>
        {% if error_message %}
                <div class="alert alert-danger alert-dismissible fade show" role="alert" style="padding-left: 2rem; padding-right: 2rem;font-size: 0.8rem; text-align: center;">
                    {{ error_message }}
                    <button type="button" class="close" data-dismiss="alert" aria-label="Close" style="right: 0px; top: -15px; width: 0; height: 0; outline:none;">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
            {% endif %}
        
        <div class="error_message_forgotpassword" id="error_forgot_password_message" style="color: red;"></div> <!-- Error message div -->
        <div id="cooldown_error_message" style="color: red;"></div>



        <!-- Modal for OTP input -->

<!-- Sign-in Section -->
<form id="signin_form" action="/signin" method="post">
    <div id="otp_error_handler_signin" style="color: red; width: 15rem; white-space: break-spaces; text-align: center;"></div>
    <div class="input-box-login">
        <input type="email" id="login_email" name="email" placeholder="Enter email" required>
    </div>
    <div class="input-box-login">
        <input type="password" name="password" placeholder="Enter password" id="password" required>
        <span class="toggle-password-login" onclick="togglePasswordVisibility()">
            <img class="eye" src="/static/images/eye-open.png" alt="Toggle Password">
        </span>
    </div>
    <div class="forgot-password-login">
        <a id="forgot_password_link" onclick="forgotPasswordBtn()">Forgot password?</a>
    </div>
    <!-- Change SIGN IN button to open modal -->
    <div class="btn-login" id="signin_button" onclick="openOtpModal()">SIGN IN</div>
    
    <!-- OTP Modal -->
    <div id="modal_signin_otp" style="display: none;flex-direction: column;justify-content: center;align-items: center;">
        <label style="align-self: baseline;padding: 10px;background: #ccf4e6;border-radius: 5px;">OTP: <input type="text" id="otp_input" name="otp" required="" style="width: inherit;"></label>
        <button class="btn-login" type="button" onclick="confirmOtp()" style="width: fit-content;">Confirm OTP</button> 
        <div id="otp_error" style="color:red;"></div>
    </div>
</form>




<script>
function openOtpModal() {
    const email = document.getElementById('login_email').value; // Get email from input
    const password = document.getElementById('password').value; // Get password from input

    $.ajax({
        url: '/send_otp_for_signin',
        method: 'POST',
        data: {
            email: email,
            password: password
        },
        success: function(response) {
            if (response.success) {
                // Show the OTP modal
                document.getElementById('modal_signin_otp').style.display = 'flex'; 
                
                // Make email and password fields read-only
                document.getElementById('login_email').setAttribute('readonly', 'readonly');
                document.getElementById('password').setAttribute('readonly', 'readonly');

                // Hide the SIGN IN button
                document.getElementById('signin_button').style.display = 'none';
                // forgot_password_link
                document.getElementById('forgot_password_link').style.display='none'
                
                // Clear previous error messages
                document.getElementById('otp_error_handler_signin').textContent = ''; 
                document.getElementById('otp_error').textContent = ''; // Clear OTP error message
            } else {
                // Display the error message returned from the server
                document.getElementById('otp_error_handler_signin').textContent = response.error_message; 
            }
        },
        error: function(xhr, status, error) {
            // Use the status code to differentiate error handling if needed
            if (xhr.status === 403) {
                document.getElementById('otp_error_handler_signin').textContent = 'Invalid credentials. Please check your email and password.'; // General message for 403 errors
            } else if (xhr.status === 404) {
                document.getElementById('otp_error_handler_signin').textContent = 'The email is not registered.'; // Handle 404 specifically
            } else {
                document.getElementById('otp_error_handler_signin').textContent = 'Invalid OTP input.'; // General error message
            }
        }
    });
}


function confirmOtp() {
    const enteredOtp = document.getElementById('otp_input').value; // Get OTP input value

    $.ajax({
        url: '/confirm_signin_otp',
        method: 'POST',
        data: {
            otp: enteredOtp,
            email: document.getElementById('login_email').value, // Include email for further processing if needed
            password: document.getElementById('password').value // Include password for final submission
        },
        success: function(response) {
            if (response.success) {
                document.getElementById('signin_form').submit(); // Submit the form if OTP is valid
            } else {
                document.getElementById('otp_error').textContent = response.error_message; // Display error message
            }
        },
        error: function(xhr, status, error) {
            document.getElementById('otp_error').textContent = 'An error occurred while verifying OTP.'; // General error message
        }
    });
}
</script>


















        <div class="signup-link-login">
            No account? <a href="/signup">Sign up</a>
        </div>
    </div>
</div>






<script>
function togglePasswordVisibility() {
            var passwordField = document.getElementById("password");
            var eyeIcon = document.querySelector(".eye");

            // Toggle the password visibility
            if (passwordField.type === "password") {
                passwordField.type = "text";
                eyeIcon.src = "/static/images/eye-close.png"; // Change image to eye-close
            } else {
                passwordField.type = "password";
                eyeIcon.src = "/static/images/eye-open.png"; // Change image to eye-open
            }

            // Apply the CSS styles
            passwordField.style.width = "100%";
            passwordField.style.padding = "10px";
            passwordField.style.border = "1px solid #ccc";
            passwordField.style.borderRadius = "5px";
            passwordField.style.fontSize = "1em";
        }

</script>
<script>
    $('#signinForm').submit(function(e) {
    e.preventDefault();  // Prevent the form from submitting traditionally

    $.ajax({
        url: '/signin',
        method: 'POST',
        data: $(this).serialize(),
        success: function(response) {
            if (response.redirect) {
                window.location.href = response.redirect;  // Redirect to the appropriate page
            } else {
                // If the response contains an error message, display it
                $('.container-login').html(response);  // Replace the form with the response content
            }
        },
        error: function() {
            alert('An error occurred. Please try again.');
        }
    });
});

</script>
</main>
{% endblock %}